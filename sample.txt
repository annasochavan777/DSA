# Parameters
$sshUrl = "ssh://git@stash.example.com:7999/PROJECT_KEY/REPO_SLUG.git" # Replace with your SSH URL
$branch = "main" # Branch, tag, or commit
$filePath = "src/main/resources/config.json" # File path in the repository
$outputFolder = "$PWD\DownloadedFiles" # Local folder to save the file
$outputFile = Join-Path -Path $outputFolder -ChildPath ([System.IO.Path]::GetFileName($filePath))

# Ensure output folder exists
if (-not (Test-Path -Path $outputFolder)) {
    New-Item -ItemType Directory -Path $outputFolder | Out-Null
}

# Construct Git command
$gitCommand = "git archive --remote=$sshUrl $branch $filePath"

# Execute Git command and capture the file content
Write-Output "Downloading file via SSH..."
$processInfo = New-Object System.Diagnostics.ProcessStartInfo
$processInfo.FileName = "git"
$processInfo.Arguments = "archive --remote=$sshUrl $branch $filePath"
$processInfo.RedirectStandardOutput = $true
$processInfo.RedirectStandardError = $true
$processInfo.UseShellExecute = $false
$processInfo.CreateNoWindow = $true

$process = New-Object System.Diagnostics.Process
$process.StartInfo = $processInfo
$process.Start() | Out-Null

# Read the output (file content)
$fileContent = $process.StandardOutput.ReadToEnd()
$process.WaitForExit()

# Ensure no error messages were received
if ($process.ExitCode -ne 0) {
    $errorMessage = $process.StandardError.ReadToEnd()
    Write-Error "Failed to download file. Error: $errorMessage"
    return
}

# Write the file content to the output file
Set-Content -Path $outputFile -Value $fileContent -Encoding utf8

# Verify the file download
if (Test-Path -Path $outputFile) {
    Write-Output "File downloaded successfully: $outputFile"
} else {
    Write-Error "Failed to save the file content locally."
}
