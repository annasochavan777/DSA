# Parameters
$projectPath = "C:\Path\To\Your\Project" # Set your project directory
$packageName = "Newtonsoft.Json"         # Set the package name to update
$newVersion = "13.0.3"                   # Set the new version

# Function to update packages.config
function Update-AllPackagesConfig {
    # Get all packages.config files in the directory and its subdirectories
    $packagesConfigFiles = Get-ChildItem -Path $projectPath -Recurse -Filter "packages.config"
    if ($packagesConfigFiles) {
        Write-Output "Found $($packagesConfigFiles.Count) packages.config file(s)."
        foreach ($file in $packagesConfigFiles) {
            # Check if the package exists in the current file
            $content = Get-Content $file.FullName
            if ($content -match "id=`"$packageName`"") {
                Write-Output "Package '$packageName' found in $($file.FullName). Updating..."
                $updatedContent = $content -replace "id=`"$packageName`".*?version=`"[^`"]+`"", "id=`"$packageName`" version=`"$newVersion`""
                $updatedContent | Set-Content $file.FullName
                Write-Output "Updated $($file.FullName) successfully."
            } else {
                Write-Output "Package '$packageName' not found in $($file.FullName). Skipping."
            }
        }
    } else {
        Write-Output "No packages.config files found."
    }
}

# Function to update .csproj file
function Update-Csproj {
    $csprojPath = Get-ChildItem -Path $projectPath -Filter *.csproj | Select-Object -First 1
    if ($csprojPath) {
        Write-Output "Updating $($csprojPath.FullName)..."
        (Get-Content $csprojPath.FullName) -replace "<PackageReference Include=`"$packageName`".*?Version=`"[^`"]+`"", "<PackageReference Include=`"$packageName`" Version=`"$newVersion`"" | Set-Content $csprojPath.FullName
        Write-Output "Updated .csproj successfully."
    } else {
        Write-Output "No .csproj file found in the project directory."
    }
}

# Function to remove .refresh files
function Remove-RefreshFiles {
    $refreshFiles = Get-ChildItem -Path $projectPath -Recurse -Filter "$packageName*.refresh"
    if ($refreshFiles) {
        Write-Output "Removing .refresh files..."
        $refreshFiles | Remove-Item -Force
        Write-Output "Removed .refresh files successfully."
    } else {
        Write-Output "No .refresh files found for $packageName."
    }
}

# Run the update functions
Update-PackagesConfig
Update-Csproj
Remove-RefreshFiles

Write-Output "NuGet package version update completed."
