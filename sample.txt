# Parameters
$projectPath = "C:\Path\To\Your\Project" # Set your project directory
$packageName = "Newtonsoft.Json"         # Set the package name to update
$newVersion = "13.0.3"                   # Set the new version

# Function to update packages.config
function Update-AllPackagesConfig {
    # Get all packages.config files in the directory and its subdirectories
    $packagesConfigFiles = Get-ChildItem -Path $projectPath -Recurse -Filter "packages.config"
    if ($packagesConfigFiles) {
        Write-Output "Found $($packagesConfigFiles.Count) packages.config file(s)."
        foreach ($file in $packagesConfigFiles) {
            # Check if the package exists in the current file
            $content = Get-Content $file.FullName
            if ($content -match "id=`"$packageName`"") {
                Write-Output "Package '$packageName' found in $($file.FullName). Updating..."
                $updatedContent = $content -replace "id=`"$packageName`".*?version=`"[^`"]+`"", "id=`"$packageName`" version=`"$newVersion`""
                $updatedContent | Set-Content $file.FullName
                Write-Output "Updated $($file.FullName) successfully."
            } else {
                Write-Output "Package '$packageName' not found in $($file.FullName). Skipping."
            }
        }
    } else {
        Write-Output "No packages.config files found."
    }
}

# Function to update .csproj file
# Function to update <Reference> nodes in .csproj files
function Update-CsprojHintPath {
    $csprojFiles = Get-ChildItem -Path $projectPath -Recurse -Filter *.csproj
    if ($csprojFiles) {
        Write-Output "Found $($csprojFiles.Count) .csproj file(s)."
        foreach ($file in $csprojFiles) {
            $content = Get-Content $file.FullName -Raw

            # Check if <Reference Include="PackageName, Version=..."> exists
            if ($content -match "<Reference Include=`"$packageName, Version=.*?`">") {
                Write-Output "Package '$packageName' found in $($file.FullName). Updating HintPath..."
                
                # Update the version in the <Reference Include="...">
                $updatedContent = $content -replace "<Reference Include=`"$packageName, Version=[^`"]+`"", "<Reference Include=`"$packageName, Version=$newVersion`""

                # Update the <HintPath> to include the new version
                $updatedContent = $updatedContent -replace "<HintPath>.*?\\$packageName\\[^\\]+\\", "<HintPath>packages\\$packageName\\$newVersion\\"

                # Write the updated content back to the file
                $updatedContent | Set-Content $file.FullName
                Write-Output "Updated HintPath in $($file.FullName) successfully."
            } else {
                Write-Output "Package '$packageName' not found in $($file.FullName). Skipping."
            }
        }
    } else {
        Write-Output "No .csproj files found."
    }
}

# Function to remove .refresh files
function Remove-RefreshFiles {
    $refreshFiles = Get-ChildItem -Path $projectPath -Recurse -Filter "$packageName*.refresh"
    if ($refreshFiles) {
        Write-Output "Removing .refresh files..."
        $refreshFiles | Remove-Item -Force
        Write-Output "Removed .refresh files successfully."
    } else {
        Write-Output "No .refresh files found for $packageName."
    }
}

# Run the update functions
Update-PackagesConfig
Update-Csproj
Remove-RefreshFiles

Write-Output "NuGet package version update completed."
